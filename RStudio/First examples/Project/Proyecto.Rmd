---
title: "Impacto del Covid en el tipo de cambio"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    # social: menu # compartir contenido
    # source_code: embed # Ver el codigo interno
    vertical_layout: fill
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(httr)
library(readxl)
library(lubridate)
library(dplyr)
library(xlsx)
suppressWarnings(suppressMessages(library(flexdashboard)))
suppressWarnings(suppressMessages(library(rAmCharts)))
suppressWarnings(suppressMessages(library(inspectdf)))
suppressWarnings(suppressMessages(library(highcharter)))
urlTipoCambio<-"https://tipodecambio.paginasweb.cr/api/"
urlCasosCovid<-"https://api.covid19api.com/country/costa-rica?from="
```

```{r message=FALSE, warning=FALSE, include=FALSE}
### Metodos extractores de datos necesarios de los API
extaerCasos<-function(datos){ #Extrae la cantidad de positivos en un vector
  aux<-NULL
  if(!is.null(datos)){
    datos<-content(datos)
    for(datos in datos){
      aux<-c(aux,datos$Confirmed)
    }
  }
  return (aux)
}

extaerfechas<-function(datos){#Extrae las fechas de positivos en un vector
  aux<-NULL
  if(!is.null(datos)){
    datos<-content(datos)
    for(contenido in datos){
      aux<-c(aux,contenido$Date)
    }
  }
  return (aux)
}
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#### Carga los tipos de cambio con respecto a la compra del dolar
cargaTipoCambio<-function(fechas){
  vectorTipoCambioCompra<-NULL
  vectorTipoCambioVenta<-NULL
  for(fecha in fechas){
    tipoCambio <- GET(url =paste0(urlTipoCambio,fecha))#Respuesta del request

    if(!is.null(tipoCambio)){
      tipoCambio<-content(tipoCambio)#Se obtiene el contenido de la respuesta
      vectorTipoCambioCompra<-c(vectorTipoCambioCompra,tipoCambio$compra)
      vectorTipoCambioVenta<-c(vectorTipoCambioVenta,tipoCambio$venta)
    }
  }
    BaseDatosTipoCambio<-data.frame(
    CompraUSD=vectorTipoCambioCompra,
    VentaUSD=vectorTipoCambioVenta)
    return(BaseDatosTipoCambio)
}
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#### CargaDatos de los API de casos covid-19 y guarda en xlsx
cargaDatos<-function(){
  library(httr)
  library(xlsx)
  library(lubridate)
  
  suppressMessages(baseDatosOriginal<-readBD())#Leer un archivo xml
  if(!is.null(baseDatosOriginal)){ # Si la base de datos tiene algo carga desde la fecha mayor a hoy
    hoy<-Sys.Date()
    fechaMayor<-ymd(max(baseDatosOriginal$Fecha))
    if(fechaMayor!=hoy & fechaMayor!= (hoy %m+% days(-1))){
      
      fechaMayor<-(fechaMayor %m+% days(1))
      casosCovid<-GET(url=paste0(urlCasosCovid,fechaMayor,"&to=",hoy))#Consume API
      Fecha<-extaerfechas(casosCovid)#Extraen todas las fechas
      Fecha<-as.Date(Fecha)
      Fecha<-format(as.Date(Fecha, format="%d/%m/%Y"),"%Y/%m/%d")
      TipoCambio<-cargaTipoCambio(Fecha)#Carga el vector de tipo de cambio
    
      BaseDatos<-data.frame(
      Fecha,
      CantidadCovid=extaerCasos(casosCovid),TipoCambio)
      BaseDatos<- rbind(baseDatosOriginal,BaseDatos)
      BaseDatos
      write.xlsx(x=BaseDatos,file = "BaseDatosCovid.xlsx",sheetName = "Datos")
    }else{
      BaseDatos<-baseDatosOriginal
    }
  }else if(is.null(baseDatosOriginal)){
    hoy<-Sys.Date() %m+% days(-1)
    
    haceTresMeses<-seq(hoy, length = 2, by = "-3 months")[2]
    casosCovid<-GET(url=paste0(urlCasosCovid,haceTresMeses,"&to=",hoy))#Consume API
    Fechas<-extaerfechas(casosCovid)#Extraen todas las fechas
    Fechas<-as.Date(Fechas)
    Fechas<-format(as.Date(Fechas, format="%d/%m/%Y"),"%Y/%m/%d")
    TipoCambio<-cargaTipoCambio(Fechas)#Carga el vector de tipo de cambio
    
    BaseDatos<-data.frame(
    Fecha=Fechas,
    CantidadCovid=extaerCasos(casosCovid),TipoCambio)
    
     write.xlsx(x=BaseDatos,file = "BaseDatosCovid.xlsx",sheetName = "Datos")
  }
  
  return(BaseDatos)
}

```

```{r message=FALSE, warning=FALSE, include=FALSE}
### Metodo que lee de la Base de datos xlsx
readBD<-function(){

  baseDatos<-NULL
  if(file.exists(paths = "BaseDatosCovid.xlsx")){#Valida que el archivo exista
    baseDatos<-read_xlsx(path = "BaseDatosCovid.xlsx",sheet = "Datos")
    baseDatos$...1<-NULL
  }
  return(baseDatos)
}

```


```{r message=FALSE, warning=FALSE, include=FALSE}
### Metodo que carga los datos del tipo de cambio antes del covid-19
#Separa la fecha, establece cantidad de casos nuevos por dia
readBeforeCovid<-function(){
  
  baseDatos<-NULL
  if(file.exists(paths = "DBTipoCambioBefore.xlsx")){#Valida que el archivo exista
    baseDatos<-read_xlsx(path = "DBTipoCambioBefore.xlsx",sheet = "BeforeCovid")
    baseDatos$...1<-NULL
  }
  return(baseDatos)
}
```

```{r message=FALSE, warning=FALSE, include=FALSE}
### Metodo que manipula los datos base
#Separa la fecha, establece cantidad de casos nuevos por dia
addColumns<-function(baseDatos){
  baseDatos <-baseDatos %>% mutate(Anio=year(Fecha),Mes=month(Fecha),Dia=day(Fecha))
   
baseDatos <-baseDatos %>% mutate(NuevosCasos=c(0,diff(CantidadCovid)))  
  return(baseDatos)
}
```

```{r message=FALSE, warning=FALSE, include=FALSE}
##Funcion que carga el tipo de cambio entre 2 fechas y lo guarda en un xlsx
## Formato de fecha ejemplo 2019-12-31
cargaTipoCambioEntreFechas<-function(Fecha1,Fecha2){
  Fechas<-seq(ymd(Fecha1),ymd(Fecha2),by="day")

  Fechas<-as.Date(Fechas)
  Fechas<-format(as.Date(Fechas, format="%d/%m/%Y"),"%Y/%m/%d")
  TipoCambio<-cargaTipoCambio(Fechas)#Carga el vector de tipo de cambio

  BaseDatos<-data.frame(Fecha=Fechas,TipoCambio)
  write.xlsx(x=BaseDatos,file = "DBTipoCambioBefore.xlsx",sheetName = "BeforeCovid",append = TRUE)
}


```

```{r message=FALSE, warning=FALSE, include=FALSE}
## Carga de datos--------------------------------
BD<-cargaDatos()

DB2019<-readBeforeCovid()

DB2019$Fecha <-ymd(DB2019$Fecha)

DBBeforeCovid<-DB2019 %>%
 select(Fecha, CompraUSD, VentaUSD) %>%
 filter(Fecha >= as.Date("2019-11-01") & Fecha <= as.Date("2020-03-05"))

BaseDatos2<-addColumns(BD)#Añade columnas

##Variables------------------------------------
### Último valor de compra registrado
ultimoCompraUSD<-max(BaseDatos2$CompraUSD)

### Último valor de venta registrado
ultimoVentaUSD<-max(BaseDatos2$VentaUSD)

### Último fecha registrada
ultimaFecha<-max(BaseDatos2$Fecha)

### Casos totales
casosTotales<-max(BaseDatos2$CantidadCovid)

##Graficos 1 gAumentoCodiv---------------------
#Aumento de casos de covid
gAumentoCodiv<-amBarplot(x = "Fecha", y = "CantidadCovid", data = BD, labelRotation = 90)

##Graficos 2 gTipoCambioMes
#Fluctuación por mes
ResumenUSDMes<-BaseDatos2 %>% group_by(Mes) %>% summarise(Compra=round(mean(CompraUSD),2),Venta=round(mean(VentaUSD),2))

#Convierte el mes en texto
ResumenUSDMes$Mes<-as.character(month(ResumenUSDMes$Mes, label = TRUE, abbr = FALSE))

gTipoCambioMes<-pipeR::pipeline(amBarplot(x = "Mes", y = c("Compra", "Venta"), data = ResumenUSDMes, legend = TRUE, main = "Comparación mensual promedio del tipo de cambio",
        mainColor = "black", mainSize = 15, creditsPosition = "top-left", ylab = "Tipo cambio",xlab = "Meses"),setChartCursor())

##Graficos 3.1 gComportamientoDolar
#Comportamiento del dolar desde el inicio de la pandemia
Meses<-as.character(month(BaseDatos2$Mes, label = TRUE, abbr = FALSE))
gComportamientoDolar <- highchart() %>% 
  hc_xAxis(categories = Meses) %>% 
  hc_add_series(name = "VentaUSD", data = BaseDatos2$VentaUSD) %>% 
  hc_add_series(name = "CompraUSD", data = BaseDatos2$CompraUSD)%>% 
  hc_title(
    text = "<b>Comportamiento del dolar desde el inicio de la pandemia</b>",
    margin = 20,
    align = "left",
    style = list(color = "black", useHTML = TRUE)
    )

##Graficos 3.2 gComportamientoCovid
#Comportamiento de los nuevos casos desde el inicio de la pandemia
Meses<-as.character(month(BaseDatos2$Mes, label = TRUE, abbr = FALSE))

gComportamientoCovid <- highchart() %>% 
  hc_xAxis(categories = Meses) %>% 
  hc_add_series(name = "Casos Nuevos", data = BaseDatos2$NuevosCasos)%>% 
  hc_title(
    text = "<b>Comportamiento de casos nuevos atravez de los meses</b>",
    margin = 20,
    align = "center",
    style = list(color = "black", useHTML = TRUE)
    )

##Graficos 4.1 gCasosMensuales
#Cantidad de contagios mensuales
ResumenCasosMes<-BaseDatos2 %>% group_by(Mes) %>% summarise(Casos=sum(NuevosCasos))

ResumenCasosMes$Mes<-as.character(month(ResumenCasosMes$Mes, label = TRUE, abbr = FALSE))

gCasosMensuales<-amBarplot(x = "Mes", y = "Casos", data = ResumenCasosMes,main = "Cantidad de contagios mensuales")
#------------------------------------------------------------------
##1.3 gBehaviorBeforeCovid
###Comportamiento del tipo de cambio antes de la pandemia
gBehaviorBeforeCovid<-highchart() %>% 
  hc_add_series(name = "VentaAntes", data = head(DBBeforeCovid,124)$VentaUSD) %>% 
  hc_add_series(name = "CompraAntes", data = head(DBBeforeCovid,124)$CompraUSD)%>% 
  hc_title(
    text = "<b>Comportamiento del tipo de cambio antes de la pandemia</b>",
    margin = 20,
    align = "left",
    style = list(color = "black", useHTML = TRUE)
    )

##1.4 gBehaviorSellCovid
###Comportamiento de la venta del dolar antes y durante la pandemia
gBehaviorSellCovid<-highchart() %>% 
  hc_add_series(name = "Durante", data = head(BaseDatos2,124)$VentaUSD) %>% 
  hc_add_series(name = "Antes", data = head(DBBeforeCovid,124)$VentaUSD) %>%
  hc_title(
    text = "<b>Comportamiento de la venta del dolar antes y durante la pandemia</b>",
    margin = 20,
    align = "left",
    style = list(color = "black", useHTML = TRUE)
    )

##1.5 gBehaviorBuyCovid
###Comportamiento de la compra del dolar antes y durante la pandemia
gBehaviorBuyCovid<-highchart() %>% 
  hc_add_series(name = "Durante", data = head(BaseDatos2,124)$CompraUSD) %>% 
  hc_add_series(name = "Antes", data = head(DBBeforeCovid,124)$CompraUSD) %>%
  hc_title(
    text = "<b>Comportamiento de la compra del dolar antes y durante la pandemia</b>",
    margin = 20,
    align = "left",
    style = list(color = "black", useHTML = TRUE)
    )
#-------------------------------------------------------------------------------
##Graficos 4.2
##ESTE SE AGARRA Y SE PEGA COMO GRAFICO PORQUE NO SE PUEDE GUARDAR EN VARIABLES
gCasosPorMes<-hchart(ResumenCasosMes, "pie", hcaes(x = Mes, y = Casos)) %>% hc_add_theme(hc_theme_538())

#----------------------------------------------------------------------------
##Graficos 5.0 gCompraCasosMes
###Comparación mensual del tipo de compra con respecto a los casos nuevos
RSCompraCovid<-BaseDatos2 %>% group_by(Mes) %>% summarise(Compra=round(mean(CompraUSD),2),Casos=round(mean(NuevosCasos),2))

#Convierte el mes en texto
RSCompraCovid$Mes<-as.character(month(RSCompraCovid$Mes, label = TRUE, abbr = FALSE))

gCompraCasosMes<-pipeR::pipeline(amBarplot(x = "Mes", y = c("Casos", "Compra"), data = RSCompraCovid, legend = TRUE, main = "Comparación mensual promedio del tipo de cambio",
        mainColor = "black", mainSize = 15, creditsPosition = "top-left", ylab = "Tipo cambio",xlab = "Meses"),setChartCursor())

##Graficos 5.1 gVentaCasosMes
###Comparación mensual del tipo de venta con respecto a los casos nuevos
RSVentaCovid<-BaseDatos2 %>% group_by(Mes) %>% summarise(Compra=round(mean(VentaUSD),2),Casos=round(mean(NuevosCasos),2))

#Convierte el mes en texto
RSVentaCovid$Mes<-as.character(month(RSVentaCovid$Mes, label = TRUE, abbr = FALSE))

gVentaCasosMes<-pipeR::pipeline(amBarplot(x = "Mes", y = c("Casos", "Compra"), data = RSVentaCovid, legend = TRUE, main = "Comparación mensual promedio del tipo de cambio",
        mainColor = "black", mainSize = 15, creditsPosition = "top-left", ylab = "Tipo cambio",xlab = "Meses"),setChartCursor())

```
## Tipo de cambio {.tabset}
### Información actualizada al `r ultimaFecha`
Análisis de información suministrada en intenet con respecto al tipo de cambio del dolar y la cantidad de casos nuevos de Covid a nivel de Costa Rica.


# Tipo de cambio {.tabset}

## My first column
### Fecha
```{r, echo=F}
valueBox(ultimaFecha, icon = "fa-calendar-o",caption = "Fecha", color="#30ADD2")

```

### Total de casos
```{r, echo=F}
valueBox(casosTotales, icon = "fa-globe",caption = "Casos Covid", color="#4CA6EC")
```

### Tipo de compra
```{r, echo=F}
valueBox(ultimoCompraUSD, icon = "fa-usd",caption = "Compra", color="#3CDC4D")

```

### Tipo de venta
```{r, echo=F}
valueBox(ultimoVentaUSD, icon = "fa-usd",caption = "Venta", color="#3CDC4D")
```

Column {data-width=200}  {.tabset}
-----------------------------------------------------------------------
### Comportamiento general durante Covid
```{r, echo=F}
gComportamientoDolar
```

### Comportamiento mensual durante Covid
```{r, echo=F}
gTipoCambioMes
```
### Comportamiento general antes del Covid
```{r, echo=F}
gBehaviorBeforeCovid
```


### Comparación tipo de venta
```{r, echo=F}
gBehaviorSellCovid
```


### Comparación tipo de compra
```{r, echo=F}
gBehaviorBuyCovid
```

# Casos Covid {.tabset}
Column {data-width=500}  {.tabset}
-----------------------------------------------------------------------

### Comportamiento general
```{r, echo=F}
gAumentoCodiv
```

### Comportamiento mensual 1.0
```{r, echo=F}
gCasosPorMes
```

### Comportamiento mensual 1.1
```{r, echo=F}
gCasosMensuales
```


```{r message=FALSE, warning=FALSE, include=FALSE}
#cargaTipoCambioEntreFechas("2019-01-01","2020-03-05")


```


```{r}
suppressWarnings(suppressMessages(library(FactoMineR)))
suppressWarnings(suppressMessages(library(factoextra)))
#Base de datos numericos
# Los valores a graficar de componentes principales se crea con la funcion PCA
Valores <- PCA(Datos, scale.unit=TRUE, # Estandarizar datos
               ncp=5, # Numero de componentes principales 
               graph = FALSE) # No graficar de una vez

Valores

plot(Valores,axes=c(1, 2), # componentes graficados
     choix="ind", # Para graficar los cantones (individuos o filas)
     col.ind="blue",new.plot=TRUE)

# Individuos
fviz_pca_ind(Valores,ggtheme=theme_get(),col.ind = "blue")
```

